<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GVSA Disco Tickets</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f4f7fa;
    }
    .form-container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .child-section {
      margin-bottom: 20px;
    }
    .payment-message {
      margin-top: 10px;
      font-style: italic;
    }
  </style>
</head>
<body>

  <div class="form-container">
    <h1>GVSA Disco Tickets</h1>
    <p>Please complete the form below to buy your tickets for the GVSA Disco.</p>

    <form id="discoForm" onsubmit="handleFormSubmit(event)">
      <!-- Your Details Section -->
      <fieldset>
        <legend>Your details</legend>
        <div class="mb-3">
          <label for="name" class="form-label">Full Name</label>
          <input type="text" class="form-control" id="name" name="name" required>
        </div>
        <div class="mb-3">
          <label for="phone" class="form-label">Telephone Number</label>
          <input type="tel" class="form-control" id="phone" name="phone" required>
	  <div id="phoneError" class="text-danger" style="display: none;">Please enter a valid phone number</div>
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">Email Address</label>
          <input type="email" class="form-control" id="email" name="email" required>
	  <div id="emailFormatError" class="text-danger" style="display: none;">Please enter a valid email address.</div>
        </div>
       <div class="mb-3">
          <label for="emailConfirm" class="form-label">Please re-enter your email address</label>
          <input type="email" class="form-control" id="emailConfirm" name="emailConfirm" required>
          <!-- Error message will appear here -->
        <div id="emailConfirmError" class="text-danger" style="display: none;">The email addresses do not match.</div>
	
        </div>
      </fieldset>

      <!-- Your Tickets Section -->
      <fieldset>
        <legend>Your tickets</legend>
        <div class="mb-3">
          <label for="numChildren" class="form-label">How many children are you buying tickets for?</label>
          <select class="form-select" id="numChildren" name="numChildren" required>
            <option value="" disabled selected>Select number of children</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
          </select>
        </div>

        <div id="childrenFields"></div> <!-- Placeholder for dynamic child fields -->
        
      </fieldset>

      <!-- Important Information Section (moved below Your Tickets) -->
      <fieldset>
        <legend>Important information</legend>
        <p>In order to make the disco happen, we need each child's parent/carer, or other nominated adult, to remain on site during the course of the disco. We also need parent volunteers to help supervise the event.  If not enough people volunteer to help, unfortunately the disco will need to be cancelled.  Please consider whether you can spare an hour (or more!) to help make this event a success.</p>
        <div class="mb-3">
          <label>
            <input type="checkbox" id="accompany" required> I understand that the named accompanying adult will be required to remain on site for the duration of the disco
          </label>
        </div>
        <div class="mb-3">
          <label>
            <input type="checkbox" id="volunteer"> I am willing to volunteer at the disco
          </label>
        </div>
        <div class="mb-3">
          <label>
            <input type="checkbox" id="msgpermission"> I am happy to receive emails about future GVSA events and activities
          </label>
        </div>
        <div class="mb-3">
          <label>
            <input type="checkbox" id="terms" required> I agree to the <a href="https://www.gvsa.org.uk/disco/disco-terms" target="_blank">terms and conditions</a>
          </label>
        </div>
      </fieldset>

      <!-- Payment Information Section -->
      <fieldset>
        <legend>Payment information</legend>
        <div class="mb-3">
          <label for="paymentMethod" class="form-label">Choose your payment method</label>
          <select class="form-select" id="paymentMethod" name="paymentMethod" required>
            <option value="">Select payment method</option>
            <option value="card">Pay by card</option>
            <option value="bank">Pay by bank transfer</option>
          </select>
        </div>

        <div id="paymentMessage" class="payment-message"></div>
      </fieldset>
      <p></p>
      <button type="submit" class="btn btn-primary">Submit</button>
    </form>
  </div>

  <script>
    // Handle dynamic fields for children
	document.getElementById('numChildren').addEventListener('change', function() {
	const numChildren = this.value;
	const childrenFieldsContainer = document.getElementById('childrenFields');

	// Store previously entered values
	let previousData = {};
	document.querySelectorAll('.child-section').forEach((section, index) => {
		previousData[index] = {
		session: document.getElementById(`session${index}`)?.value || '',
		childName: document.getElementById(`childName${index}`)?.value || '',
		childClass: document.getElementById(`childClass${index}`)?.value || '',
		allergies: document.getElementById(`allergies${index}`)?.value || '',
		accompanyingAdult: document.getElementById(`accompanyingAdult${index}`)?.value || '',
		meChecked: document.getElementById(`me${index}`)?.checked || false
		};
	});

	childrenFieldsContainer.innerHTML = ''; // Clear previous child fields

	if (numChildren) {
		for (let i = 0; i < numChildren; i++) {
		const childSection = document.createElement('div');
		childSection.classList.add('child-section');
		childSection.innerHTML = `
			<h5>Child ${i + 1}</h5>
			<div class="mb-3">
			<label for="session${i}" class="form-label">Session</label>
			<select class="form-select" id="session${i}" name="session${i}" required>
				<option value="session1">Session 1 (Years R/1/2) - 3pm to 4pm</option>
				<option value="session2">Session 2 (Years 3/4) - 4:30pm to 5:30pm</option>
				<option value="session3">Session 3 (Years 5/6) - 6pm to 7pm</option>
			</select>
			</div>
			<div class="mb-3">
			<label for="childName${i}" class="form-label">Child's Full Name</label>
			<input type="text" class="form-control" id="childName${i}" name="childName${i}" required>
			</div>
			<div class="mb-3">
			<label for="childClass${i}" class="form-label">Child's Class</label>
			  
   			<!-- <input type="text" class="form-control" id="childClass${i}" name="childClass${i}" required> -->
			<!-- Above line used when class was a text box. Replaced with dropdown below.-->
			<select class="form-select" id="childClass${i}" name="childClass${i}" required>
            			<option value="" disabled selected>Select Class</option>
            			<option value="YR">YR Robin</option>
	       			<option value="YR">YR Sparrow</option>
            			<option value="1">Y1 Goldfinch</option>
	       			<option value="1">Y1 Kingfisher</option>
            			<option value="2">Y2 Blackbird</option>
	       			<option value="2">Y2 Swallow</option>
            			<option value="3">Y3 Jay</option>
	       			<option value="3">Y3 Owl</option>
            			<option value="4">Y4 Swift</option>
	       			<option value="4">Y4 Wagtail</option>
			        <option value="5">Y5 Nightingale</option>
	       			<option value="5">Y5 Woodpecker</option>
            			<option value="6">Y6 Falcon</option>
	       			<option value="6">Y6 Kestrel</option>
        		</select>
   			</div>
			<div class="mb-3">
			<label for="allergies${i}" class="form-label">Allergies or Medical Requirements</label>
			<textarea class="form-control" id="allergies${i}" name="allergies${i}" placeholder="Enter details or leave blank if none"></textarea>
			</div>
			<div class="mb-3">
			<label for="accompanyingAdult${i}" class="form-label">Name of Accompanying Adult</label>
			<div class="form-check">
				<input type="checkbox" class="form-check-input" id="me${i}" name="me${i}">
				<label class="form-check-label" for="me${i}">Me</label>
			</div>
			<input type="text" class="form-control" id="accompanyingAdult${i}" name="accompanyingAdult${i}" required>
			</div>
			<hr>
			`;
		childrenFieldsContainer.appendChild(childSection);

		// Restore previous values if they exist
		if (previousData[i]) {
			document.getElementById(`session${i}`).value = previousData[i].session;
			document.getElementById(`childName${i}`).value = previousData[i].childName;
			document.getElementById(`childClass${i}`).value = previousData[i].childClass;
			document.getElementById(`allergies${i}`).value = previousData[i].allergies;
			document.getElementById(`accompanyingAdult${i}`).value = previousData[i].accompanyingAdult;
			document.getElementById(`me${i}`).checked = previousData[i].meChecked;
			}
		}
	}
	});

	// Update accompanying adult name when the parent's name field changes
	document.getElementById('name').addEventListener('input', function() {
    	document.querySelectorAll('[id^="me"]').forEach(checkbox => {
	        const index = checkbox.id.replace('me', '');  
	        const accompanyingAdultInput = document.getElementById(`accompanyingAdult${index}`);
	
	        if (checkbox.checked) {
            	accompanyingAdultInput.value = this.value;  // Update with the parent's name
        	}
    		});
	});
	
	  
	// Handle the "Me" checkbox interaction for each child
	document.addEventListener('change', function(event) {
	if (event.target && event.target.id.startsWith('me')) {
		const childIndex = event.target.id.replace('me', '');  // Extract index from ID
		const accompanyingAdultInput = document.getElementById(`accompanyingAdult${childIndex}`);
		const nameField = document.getElementById('name'); // Parent's name field
		if (event.target.checked) {
			// If "Me" is checked, set the accompanying adult's name to the parent's name and disable the field
			accompanyingAdultInput.value = nameField.value;
			accompanyingAdultInput.disabled = true;
		} else {
			// If "Me" is unchecked, clear the field and enable it again
			accompanyingAdultInput.value = '';
			accompanyingAdultInput.disabled = false;
		}
	}
	});

function validateEmail(email) {
    // Regular expression for validating email format
    const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    return emailPattern.test(email);
}

// Function to check emails match and validate format
function checkEmailValid() {
    const email = document.getElementById('email').value.trim();
    const emailFormatError = document.getElementById('emailFormatError');
    let isValid = true;
	
	// If email is blank, skip validation
    if (email === '') {
	emailFormatError.style.display = 'none';
	    return isValid; // Skip the validation
    }

    // Validate email format
    if (!validateEmail(email)) {
        emailFormatError.style.display = 'block';
        isValid = false;
    } else {
        emailFormatError.style.display = 'none';
    }
    return isValid;
}

function checkEmailSame() {
    const email = document.getElementById('email').value.trim();
    const emailConfirm = document.getElementById('emailConfirm').value.trim();
    const emailError = document.getElementById('emailConfirmError');
    const emailFormatError = document.getElementById('emailFormatError');

    let isValid = true;
    // Check if emails match
    if (email !== emailConfirm) {
        emailError.style.display = 'block';
        isValid = false;
    } else {
        emailError.style.display = 'none';
    }

    return isValid;
}

 // Validate UK phone number (must start with 07, 01, or 02 and contain 11 digits, spaces allowed)
  function validatePhoneNumber(phone) {
    // Remove spaces to count only digits
    const cleanedPhone = phone.replace(/\s+/g, '');

    // Regex to check if phone starts with 07, 01, or 02 and has exactly 11 digits
    const phonePattern = /^(07|01|02)\d{9}$/;

    return phonePattern.test(cleanedPhone);
  }

  // Function to check phone number format
  function checkPhoneNumber() {
    const phone = document.getElementById('phone').value.trim();
    const phoneError = document.getElementById('phoneError');

    let isValid = true;
    // Check if phone number matches the valid pattern
    if (!validatePhoneNumber(phone)) {
      phoneError.style.display = 'block';
      isValid = false;
    } else {
      phoneError.style.display = 'none';
    }

    return isValid;
  }
	  
	  
	  
// Run validation when the user leaves the email and phone fields
document.getElementById('email').addEventListener('blur', checkEmailValid);
document.getElementById('emailConfirm').addEventListener('blur', checkEmailSame);
document.getElementById('phone').addEventListener('blur', checkPhoneNumber);
	  
// Prevent form submission if emails are invalid
//document.getElementById('discoForm').addEventListener('submit', function(event) {
 //   if (!checkEmailValid()) {
 //       event.preventDefault(); // Stop form submission
 //       alert("Please enter a valid email address and ensure both emails match.");
 //   }
//	if (!checkEmailSame()) {
//        event.preventDefault(); // Stop form submission
//        alert("Please enter a valid email address and ensure both emails match.");
//    }
//});
	  
    // Show appropriate message based on selected payment method
    document.getElementById('paymentMethod').addEventListener('change', function() {
      const paymentMessageElement = document.getElementById('paymentMessage');
      const selectedPaymentMethod = this.value;
      if (selectedPaymentMethod === 'card') {
        paymentMessageElement.innerHTML = "You will be redirected to our card payment processor (Stripe) once you have submitted this form.";
      } else if (selectedPaymentMethod === 'bank') {
        paymentMessageElement.innerHTML = "Once you have submitted this form, you will be redirected to the payment information page. Payment information will also be sent to you by email.";
      } else {
        paymentMessageElement.innerHTML = ''; // Clear message if no selection
      }
    });

    // Handle form submission
    function handleFormSubmit(event) {
   //   event.preventDefault();  // Prevent the default form submission


	 if (!checkEmailValid()) {
        event.preventDefault(); // Stop form submission
		 return;
       //alert("Please enter a valid email address and ensure both emails match.");
   }
	if (!checkEmailSame()) {
        event.preventDefault(); // Stop form submission
		return;
       // alert("Please enter a valid email address and ensure both emails match.");
    }

	    // Check phone number validity
    if (!checkPhoneNumber()) {
        event.preventDefault(); // Stop form submission
      return;  // Stop form submission if phone number is invalid
    }

      //Disable the submission button to avoid multiple clicks
      const submitButton = document.querySelector('button[type="submit"]');
      submitButton.textContent = 'Submitting...';
      submitButton.disabled = true;

    // Collect form data
    var formData = {
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        numChildren: document.getElementById('numChildren').value,
        paymentMethod: document.getElementById('paymentMethod').value,
        agreeTerms: document.getElementById('terms').checked,
        agreeMsg: document.getElementById('msgpermission').checked,
        agreeStay: document.getElementById('accompany').checked,
        willVolunteer: document.getElementById('volunteer').checked,
		};

	// Collect children data
	var childrenData = [];
		for (let i = 0; i < formData.numChildren; i++) {
        childrenData.push({
          session: document.getElementById(`session${i}`).value,
          childName: document.getElementById(`childName${i}`).value,
          childClass: document.getElementById(`childClass${i}`).value,
          allergies: document.getElementById(`allergies${i}`).value,
          accompanyingAdult: document.getElementById(`accompanyingAdult${i}`).value
        });
      }
      formData.children = childrenData;

	// **Replace with your actual Apps Script Web App URL**
	const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwsVPxZvL9ChglarrkN06QAzNsOcT0n5vYRlqZht0CJt5aB1Rpo-Lj3UjHVGoZoaiPu/exec";

	// Send the data to the Google Apps Script Web App
	fetch(APPS_SCRIPT_URL, {
		redirect: "follow",
		method: "POST",
		mode: "cors",
		headers: { "Content-Type": "text/plain;charset=utf-8" },
		body: JSON.stringify(formData),
	})
	.then(response => response.text()) // or `.json()` if your script returns JSON
	.then(paymentUrl => {
    if (formData.paymentMethod === "card") {
		window.location.href = paymentUrl; // Redirect for card payments
    } else {
		document.body.innerHTML = paymentUrl; // Show bank transfer details
    }
	})
  .catch(error => {
		console.error("Error:", error);
		alert("There was an error submitting the form: " + error);
	});
	}
  </script>

</body>
</html>
